<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>2048</title>

  <style type="text/css">
        #game {
            width: 500px;
            height: 500px;
            background: gray;
            padding: 10px;
            border-radius: 8px;
            position: relative;
        }
        .column, .tile {
                border-radius: 8px;
                width: 100px;
                height: 100px;
                margin: 25px;
                position: absolute;
        }
        .column {
            background: lightgray;
            z-index: 1;
        }
        .tile {
            text-align: center;
            z-index: 10;
        }
  </style>
</head>

<body>
    <h1>Qlik assignment</h1>

    <div id="game"></div>

    <script type="text/javascript">

        var engine = {
            rows: [],
            tiles: [],
            setup: function() {
                // create four rows, each row contaning four columns
                this.rows = [];
                this.tiles = [];
                for(var i = 0; i < 4; i++) {
                    var columns = [];
                    for(var j = 0; j < 4; j++) {
                        // each column contains values for x and y.
                        columns[j] = new column(i, j);
                    }
                    // add the row with it's columns to the array
                    this.rows.push(new row(columns));
                }

                // setup a game area.
                // get the div 'game' by id
                var game = document.getElementById('game');
                // for each row, call the render
                for(var i = 0; i < this.rows.length; i++) {
                    this.rows[i].render(game);
                }
            },
            start: function() {
                var engine = this;
                // When the game is started, two tiles ar generated
                engine.generateTile();
                engine.generateTile();

                window.addEventListener('keydown', function (e) {
                    console.log(e.keyCode);
                    if(e.keyCode == 37) { // Left
                        // start by doing a basic loop on the y-axis(rows)
                        // for each row, get all the tiles that's on that row, then sort them by x
                        for(let i = 0; i < 4; i++) {
                            var tilesOnRow = [];
                            for(let j = 0; j < engine.tiles.length; j++) {
                                if(engine.tiles[j].y === i) {
                                    tilesOnRow.push(engine.tiles[j]);
                                }
                            }

                            tilesOnRow = tilesOnRow.sort(function(t1, t2) {
                                return t1.x < t2.x;
                            });


                            // fore each tile on row, check all columns to the left(index < x).
                            // if it's empty, move the tile
                            for(var j = 0; j < tilesOnRow.length; j++) {
                                var t = tilesOnRow[j];
                                var x = t.x;
                                for(let k = x-1; k >= 0; k--) {
                                    if(engine.rows[i].columns[k].isEmpty()) {
                                        // remove tile for old column
                                        engine.rows[t.y].columns[t.x].removeTile();
                                        // move tile
                                        t.move(t.y, k);
                                        // add tile to new column
                                        engine.rows[i].columns[k].addTile(t);
                                    }
                                }
                            }
                        }                 
                    }
                })
            },
            generateTile: function() {
                var engine = this;
                var num = Math.round(Math.random()) == 0 ? 2 : 4;

                // get a column where the is no tile 
                let emptyColumnFound = false;
                while(!emptyColumnFound) {
                    // generate two random numers, one for x axis and one for y axis
                    const x = Math.round(Math.random()*3);
                    const y = Math.round(Math.random()*3);

                    // get the column from the game object
                    // if column.isEmpty, the place the tile in the column
                    // set emptyColumnFound to true to end the while loop
                    const column = engine.rows[y].columns[x];
                    if(column.isEmpty()) {

                        var t = new tile(num, y, x);

                        column.addTile(t);
                        engine.tiles.push(t);
                        
                        emptyColumnFound = true;
                    }
                }


                var game = document.getElementById('game');
                t.render(game);
            }
        }

        function row(columns) {
            this.columns = columns
        };

        row.prototype.render = function(game) {
            for(var i = 0; i < this.columns.length; i++) {
                this.columns[i].render(game);
            }
        }

        function column(y, x) {
            this.y = y;
            this.x = x;
            this.id = `${y}_${x}`
            this.tile = null;
        }

        column.prototype.render = function(game) {
            // create a div, set id and class
            var div = document.createElement("div");
            div.id = this.id;
            div.classList.add('column');
            
            // set the position of the div.
            // I use alot of hardcoded values, this neet to be fixed
            // the game element is 500px wide, (4 * 100) + (20 * x) will position the columns right 
            div.style.left = (this.x * 100) + 25 * this.x +'px';
            div.style.top = (this.y * 100)  + 25 * this.y +'px';

            game.appendChild(div);
        }

        column.prototype.addTile = function(tile) {
            this.tile = tile;
        }

        column.prototype.removeTile = function() {
            this.tile = null;
        }

        column.prototype.isEmpty = function() {
            return !this.tile;
        }

        function tile(num, y, x) {
            
            this.num = num;
            this.x = x;
            this.y = y;
            this.id = `tile_${y}_${x}`

            this.backgroundColor = function () {
                return "green";
            }    

            this.fontSize = function() {
                return 45;
            }
        }

        tile.prototype.render = function(game) {
            // create a div, set id and class
            var div = document.createElement("div");
            div.id = this.id;
            div.classList.add('tile');
            div.innerHTML = this.num;

            // set the position of the div.
            // I use alot of hardcoded values, this neet to be fixed
            // the game element is 500px wide, (4 * 100) + (20 * x) will position the columns right 
            div.style.left = (this.x * 100) + 25 * this.x +'px';
            div.style.top = (this.y * 100)  + 25 * this.y +'px';
            
            // set background color and font-size based on num
            div.style.background = this.backgroundColor();
            div.style.fontSize = this.fontSize() + 'px';

            game.appendChild(div);
        }

        tile.prototype.move = function(y, x, num) {

            var div = document.getElementById(this.id);

            this.x = x;
            this.y = y;
            this.num = num;
            this.id = `tile_${this.y}_${this.x}`

            div.style.left = (this.x * 100) + 25 * this.x +'px';
            div.style.top = (this.y * 100)  + 25 * this.y +'px';
            div.id = this.id;
        }

        engine.setup();
        engine.start();
    </script>
</body>
</html>