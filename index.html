<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>2048</title>

  <style type="text/css">
        #game {
            width: 500px;
            height: 500px;
            background: gray;
            padding: 10px;
            border-radius: 8px;
            position: relative;
        }
        .column, .tile {
                border-radius: 8px;
                width: 100px;
                height: 100px;
                margin: 25px;
                position: absolute;
        }
        .column {
            background: lightgray;
            z-index: 1;
        }
        .tile {
            text-align: center;
            z-index: 10;
        }
  </style>
</head>

<body>
    <h1>Qlik assignment</h1>

    <div id="game"></div>

    <script type="text/javascript">

        var engine = {
            rows: [],
            tiles: [],
            setup: function() {
                // create four rows, each row contaning four columns
                this.rows = [];
                this.tiles = [];
                for(var i = 0; i < 4; i++) {
                    var columns = [];
                    for(var j = 0; j < 4; j++) {
                        // each column contains values for x and y.
                        columns[j] = new column(i, j);
                    }
                    // add the row with it's columns to the array
                    this.rows.push(new row(columns));
                }

                // setup a game area.
                // get the div 'game' by id
                var game = document.getElementById('game');
                // for each row, call the render
                for(var i = 0; i < this.rows.length; i++) {
                    this.rows[i].render(game);
                }
            },
            start: function() {
                var engine = this;
                // When the game is started, two tiles ar generated
                engine.generateTile();
                engine.generateTile();

                window.addEventListener('keydown', function (e) {
                    console.log(e.keyCode);
                    var didMoveTile = false;
                    if(e.keyCode == 37) { // Left
                        // for each row, get all tiles and sort them by x in ascending
                        // loop over all columns with an index less then x (down to 0) of tile stating at tile x - 1(first possible column to move to)
                        // try to move the tile
                        for(var i = 0; i < 4; i++) {
                            var tilesOnRow = engine.getTilesByRow(i);

                            tilesOnRow = tilesOnRow.sort(function(t1, t2) {
                                 return t1.x - t2.x;
                            });

                            for(var j = 0; j < tilesOnRow.length; j++) {
                                var t = tilesOnRow[j];
                                for(let k = t.x-1; k >= 0; k--) {
                                    var didAMove = engine.tryMoveTile(i, k, t);

                                    if(!didMoveTile  && didAMove) {
                                        didMoveTile = true;
                                    }
                                }
                            }
                        }                 
                    } else if(e.keyCode == 39) { // Right
                        // for each row, get all tiles and sort them by x in descending
                        // loop over all columns with an index grader then x (up to 3) of tile stating at tile x + 1(first possible column to move to)
                        // try to move the tile
                        for(var i = 0; i < 4; i++) {
                            var tilesOnRow = engine.getTilesByRow(i);
                            
                            tilesOnRow = tilesOnRow.sort(function(t1, t2) {
                                 return t2.x - t1.x;
                            });

                            for(var j = 0; j < tilesOnRow.length; j++) {
                                var t = tilesOnRow[j];
                                for(let k = t.x+1; k < 4; k++) {
                                    var didAMove = engine.tryMoveTile(i, k, t);
                                    
                                    if(!didMoveTile  && didAMove) {
                                        didMoveTile = true;
                                    }
                                }
                            }
                        }       
                    } else if(e.keyCode == 38) { // Up
                        // for each column, get all tiles and sort them by y in ascending
                        // loop over all rows with an index less then y (down to 0) of tile stating at tile y - 1(first possible row to move to)
                        // try to move the tile
                        for(var i = 0; i < 4; i++) {
                            var tilesOnColumn = engine.getTilesByColumn(i);

                            tilesOnColumn = tilesOnColumn.sort(function(t1, t2) {
                                return t1.y - t2.y;
                            });

                            for(var j = 0; j < tilesOnColumn.length; j++) {
                                var t = tilesOnColumn[j];
                                for(let k = t.y-1; k >= 0; k--) {
                                    var didAMove = engine.tryMoveTile(k, i,  t);

                                    if(!didMoveTile  && didAMove) {
                                        didMoveTile = true;
                                    }
                                }
                            }
                        }
                    } else if(e.keyCode == 40) { // Down
                        // for each column, get all tiles and sort them by y in descending
                        // loop over all rows with an index grader then y (up to 3) of tile stating at tile y + 1(first possible row to move to)
                        // try to move the tile
                        for(var i = 0; i < 4; i++) {
                            var tilesOnColumn = engine.getTilesByColumn(i);

                            tilesOnColumn = tilesOnColumn.sort(function(t1, t2) {
                                return t2.y - t1.y;
                            });

                            for(var j = 0; j < tilesOnColumn.length; j++) {
                                var t = tilesOnColumn[j];
                                for(let k = t.y+1; k < 4; k++) {
                                    var didAMove = engine.tryMoveTile(k, i, t);
                                    
                                    if(!didMoveTile  && didAMove) {
                                        didMoveTile = true;
                                    }
                                }
                            }
                        }
                    }

                    // if any of the arrow keys was pushed and atleast one tile was moved, generate a new tile
                    if(e.keyCode >= 37 && e.keyCode <= 40 && didMoveTile) {
                        engine.generateTile(engine.tiles.length + 1);
                    }
                })
            },
            generateTile: function() {
                var engine = this;
                var num = Math.round(Math.random()) == 0 ? 2 : 4;

                // get a column where the is no tile 
                let emptyColumnFound = false;
                while(!emptyColumnFound) {
                    // generate two random numers, one for x axis and one for y axis
                    const x = Math.round(Math.random()*3);
                    const y = Math.round(Math.random()*3);

                    // get the column from the game object
                    // if column.isEmpty, the place the tile in the column
                    // set emptyColumnFound to true to end the while loop
                    const column = engine.rows[y].columns[x];
                    if(column.isEmpty()) {

                        var t = new tile(num, y, x);

                        column.addTile(t);
                        engine.tiles.push(t);
                        
                        emptyColumnFound = true;
                    }
                }

                var game = document.getElementById('game');
                t.render(game);
            },
            tryMoveTile: function(row, column, tile) {
                var engine = this;
                if(engine.rows[row].columns[column].isEmpty()) {
                    // remove tile for old column
                    engine.rows[tile.y].columns[tile.x].removeTile();
                    // move tile
                    tile.move(row, column);
                    // add tile to new column
                    engine.rows[row].columns[column].addTile(tile);

                    return true;
                }
            },
            getTilesByRow: function(row) {
                var engine = this;
                var tiles = [];
                for(var j = 0; j < engine.tiles.length; j++) {
                    if(engine.tiles[j].y === row) {
                        tiles.push(engine.tiles[j]);
                    }
                }

                return tiles;
            },
            getTilesByColumn: function(column) {
                var engine = this;
                var tiles = [];
                for(var j = 0; j < engine.tiles.length; j++) {
                    if(engine.tiles[j].x === column) {
                        tiles.push(engine.tiles[j]);
                    }
                }

                return tiles;
            }
        }

        function row(columns) {
            this.columns = columns
        };

        row.prototype.render = function(game) {
            for(var i = 0; i < this.columns.length; i++) {
                this.columns[i].render(game);
            }
        }

        function column(y, x) {
            this.y = y;
            this.x = x;
            this.id = `${y}_${x}`
            this.tile = null;
        }

        column.prototype.render = function(game) {
            // create a div, set id and class
            var div = document.createElement("div");
            div.id = this.id;
            div.classList.add('column');
            
            // set the position of the div.
            // I use alot of hardcoded values, this neet to be fixed
            // the game element is 500px wide, (4 * 100) + (20 * x) will position the columns right 
            div.style.left = (this.x * 100) + 25 * this.x +'px';
            div.style.top = (this.y * 100)  + 25 * this.y +'px';

            game.appendChild(div);
        }

        column.prototype.addTile = function(tile) {
            this.tile = tile;
        }

        column.prototype.removeTile = function() {
            this.tile = null;
        }

        column.prototype.isEmpty = function() {
            return !this.tile;
        }

        function tile(num, y, x) {
            
            this.num = num;
            this.x = x;
            this.y = y;
            this.id = `tile_${y}_${x}`

            this.backgroundColor = function () {
                return "green";
            }    

            this.fontSize = function() {
                return 45;
            }
        }

        tile.prototype.render = function(game) {
            // create a div, set id and class
            var div = document.createElement("div");
            div.id = this.id;
            div.classList.add('tile');
            div.innerHTML = this.num;

            // set the position of the div.
            // I use alot of hardcoded values, this neet to be fixed
            // the game element is 500px wide, (4 * 100) + (20 * x) will position the columns right 
            div.style.left = (this.x * 100) + 25 * this.x +'px';
            div.style.top = (this.y * 100)  + 25 * this.y +'px';
            
            // set background color and font-size based on num
            div.style.background = this.backgroundColor();
            div.style.fontSize = this.fontSize() + 'px';

            game.appendChild(div);
        }

        tile.prototype.move = function(y, x, num) {

            var div = document.getElementById(this.id);

            this.x = x;
            this.y = y;
            this.num = num;
            this.id = `tile_${this.y}_${this.x}`

            div.style.left = (this.x * 100) + 25 * this.x +'px';
            div.style.top = (this.y * 100)  + 25 * this.y +'px';
            div.id = this.id;
        }

        engine.setup();
        engine.start();
    </script>
</body>
</html>